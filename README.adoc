
== Build and run a Cloudera trial environment in a dockerless container

Based on https://github.com/carrossoni/CDPDCTrial/

----
We'll use buildah 
to create the Cloudera CDP Private Cloud Base 
(formerly known as CDP Data Center)
trial environment container 

and

podman to run it
----

See https://www.cloudera.com/products/cloudera-data-platform/cdp-private-cloud.html

image:images/cloudera3.png[title="Cloudera 3"]

----
The trial environment also includes a  wizard that provides 
step-by-step guidance for installing CDP Private Cloud components onto an existing on-premises Kubernetes cluster. 

After the installation, you can manage your 
CDP Private Cloud environments and experiences 
from the CDP Private Cloud Management Console.
----


image:images/cloudera2.png[title="Cloudera 2"]


NOTE: You can automate the install of OpenShift 4.5 with YuniKorn scheduler for BigData and ML 
on your laptop, virtual machine or baremetal server using CodeReady Containers

See https://issues.apache.org/jira/browse/YUNIKORN-422 and 
https://github.com/marcredhat/crcdemos/blob/master/yunikorn/README.adoc


----
YuniKorn brings a unified, cross-platform scheduling experience for mixed workloads 
consisting of stateless batch workloads and stateful services, 
with support for, but not limited to, YARN and Kubernetes.
----

----
Buildah is a command-line tool for building Open Container Initiative-compatible 
(that means Docker- and Kubernetes-compatible, too) images quickly and easily. 
Buildah is easy to incorporate into scripts and build pipelines and 
doesnâ€™t require a running container daemon to build its image.
See more at https://opensource.com/article/18/6/getting-started-buildah
----


The buildah script to create the container is at https://github.com/marcredhat/cloudera/blob/master/build.sh

----
curl -L https://raw.githubusercontent.com/marcredhat/cloudera/master/build.sh -o build.sh
chmod +x ./build.sh
./build.sh
----

----
Let's have a look at the container created by the script above

sudo buildah containers
CONTAINER ID  BUILDER  IMAGE ID     IMAGE NAME                       CONTAINER NAME
ed92c18b5b99     *     f142359e2130 registry.centos.org/centos/centos:latest centos-working-container-1
----

----
Commit the container to a new image

sudo buildah commit centos-working-container-1 marccdp
----

----
Publish the container to your favorite registry

sudo podman  login -u="<quay.io user>" -p="<quay.io encrypted password>" quay.io
sudo  podman push localhost/marccdp  quay.io/marcf5/marccdp
----

----
Starting services within the container using systemd
(from https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/using-systemd-with-containers_building-running-and-managing-containers)

Applications created to be managed with systemd can be started and managed inside a container. 
A container running systemd will:

Start the /sbin/init process (the systemd service) to run as PID 1 within the container.
Start all systemd services that are installed and enabled within the container, in order of dependencies.
Allow systemd to restart services or kill zombie processes for services started within the container.
The general steps for building a container that is ready to be used as a systemd services is:

Install the package containing the systemd-enabled service inside the container.

Use the systemctl command to enable the service inside the container.

Expose any ports needed to access the service.
----

----
sudo podman run  -p 7180:7180 --systemd=true --privileged  -it --name marccdp localhost/marccdp:latest /sbin/init
----

----
We can now connect to the Cloudera trial environment container and
configure databases, enable service etc
as shown at https://github.com/marcredhat/CDPDCTrial/blob/master/centosvmCDP.sh

sudo podman exec -it marccdp /bin/bash

Examples:
[root@6de36c33185f /]# systemctl start cloudera-scm-server
[root@6de36c33185f /]# su - postgres -c "/usr/pgsql-9.6/bin/initdb --locale en_US.UTF-8 -D '/var/lib/postgres/data'"
[root@6de36c33185f /]# su - postgres -c "/usr/pgsql-9.6/bin/pg_ctl -D /var/lib/postgres/data -l logfile start"

[root@6de36c33185f /]# find / -name create_cluster.py
/CDPDCTrial/scripts/create_cluster.py

[root@6de36c33185f /]# python /CDPDCTrial/scripts/create_cluster.py /CDPDCTrial/conf/cdpsandbox.json
----

----
[root@6de36c33185f /]# ss -anpt | grep java | grep LISTEN
LISTEN     0      50           *:7180                     *:*                   users:(("java",pid=14718,fd=400))
LISTEN     0      50           *:7182                     *:*                   users:(("java",pid=14718,fd=392))
----

----
[root@6de36c33185f /]# systemctl status cloudera-scm-agent
[root@6de36c33185f /]# systemctl status cloudera-scm-server 
----

----
[root@6de36c33185f /]# curl -u "admin:admin"  http://127.0.0.1:7180/api/version
v41
----

----
[root@6de36c33185f /]# tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log
----
